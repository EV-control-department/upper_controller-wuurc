# 组件轮询机制

## 功能描述

在ROV控制系统初始化过程中，添加了组件轮询机制，确保所有关键组件（视频流、手柄、温湿度计、电流下发）都准备就绪后再启动主程序。这个机制提供了以下好处：

1. 确保系统在所有组件就绪后才开始运行，提高系统稳定性
2. 为用户提供直观的初始化状态反馈
3. 允许系统在某些组件未就绪的情况下仍尝试启动，同时提供警告
4. 为组件初始化提供足够的时间，避免启动过快导致的连接问题

## 实现细节

### 组件检查标准

系统检查以下组件的就绪状态：

1. **视频流 (VideoThread)**
    - 检查标准：`video_thread.video_connected` 为 `True` 且 `video_thread.frame_queue` 中有帧
    - 超时时间：10秒
    - 状态反馈："视频流已连接" 或 "视频流连接超时"

2. **手柄 (JoystickHandler)**
    - 检查标准：`joystick_handler.joystick` 不为 `None`
    - 超时时间：5秒
    - 状态反馈："手柄已连接" 或 "未检测到手柄"
    - 附加功能：在检查过程中尝试重新初始化手柄

3. **温湿度传感器 (ControllerMonitor)**
    - 检查标准：`controller_monitor.depth` 或 `controller_monitor.temperature` 的值与初始值不同
    - 超时时间：8秒
    - 状态反馈："温湿度传感器已连接" 或 "温湿度传感器连接超时"

4. **电流下发 (NetworkWorker)**
    - 检查标准：`network_worker.running` 为 `True` 且能成功发送控制器数据
    - 超时时间：8秒
    - 状态反馈："电流下发已就绪" 或 "电流下发初始化超时"

### 用户界面反馈

轮询过程中，系统提供以下用户界面反馈：

1. 初始化开始时显示"系统初始化中..."
2. 每个组件检查过程中显示"正在检测..."状态
3. 每个组件检查完成后显示结果，使用颜色编码：
    - 绿色：组件就绪
    - 红色：组件未就绪
4. 所有组件检查完成后显示总体状态：
    - 绿色："所有组件已就绪，即将启动主程序..."
    - 橙色："部分组件未就绪，将尝试启动主程序..."
5. 等待3秒让用户查看状态后启动主程序

### 代码实现

在 `MainController` 类中添加了 `_wait_for_components()` 方法，该方法在构造函数的最后被调用。方法实现了上述的组件检查逻辑，包括：

1. 显示初始化界面
2. 按顺序检查每个组件
3. 为每个组件提供视觉反馈
4. 显示总体状态
5. 等待用户查看后启动主程序

## 使用说明

该功能是自动执行的，不需要用户干预。在系统启动时，用户将看到初始化界面，显示各组件的检测状态。如果某些组件未就绪，系统会显示警告但仍会尝试启动。

## 注意事项

1. 如果视频流未连接，系统仍会启动，但可能无法显示视频
2. 如果手柄未连接，系统仍会启动，但无法通过手柄控制ROV
3. 如果温湿度传感器未连接，系统仍会启动，但无法显示温度和深度数据
4. 如果电流下发未就绪，系统仍会启动，但可能无法控制ROV的电机

## 未来改进

1. 添加配置选项，允许用户设置是否在某些关键组件未就绪时阻止系统启动
2. 为每个组件添加重试机制，在初始化失败时自动尝试重新连接
3. 添加更详细的错误信息，帮助用户诊断连接问题
4. 添加组件状态的持续监控，在运行过程中检测组件断开并提供警告