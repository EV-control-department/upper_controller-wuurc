# ROV 控制系统新手指南

本项目及指南基于25届ROV“超越”编写，将帮助你了解系统的架构、原理和使用方法，让你能够快速上手并充分利用这个强大的工具。

## 目录

1. [系统概述](#系统概述)
2. [硬件与软件架构](#硬件与软件架构)
3. [安装与设置](#安装与设置)
4. [配置选项](#配置选项)
5. [使用说明](#使用说明)
6. [设计原理](#设计原理)
7. [工作流程](#工作流程)
8. [故障排除](#故障排除)
9. [进阶开发](#进阶开发)

## 系统概述

ROV 控制系统是一个用于操控水下机器人的上位机软件，它允许操作手通过 Xbox 控制器精确地控制 ROV
的移动和操作。系统提供了实时视频流显示、深度和温度监控、舵机控制等功能。

### 主要特点

- **实时视频流**：通过 RTSP 协议接收并显示 ROV 摄像头捕获的实时画面
- **精确控制**：使用 Xbox 控制器进行直观的六自由度控制
- **多种控制模式**：支持不同速度模式和精细操作模式（建议基于操作手喜好改写）
- **深度温度监控**：实时显示并记录 ROV 的深度和水温数据
- **模块化设计**：系统采用模块化架构，便于维护和扩展
- **非阻塞处理**：使用多线程技术确保系统响应迅速，不会因某一操作而卡顿

## 硬件与软件架构

### 硬件架构

ROV 控制系统的硬件架构包括以下组件：

1. **上位机**：运行控制软件的计算机，通常是一台 Windows 笔记本电脑
2. **Xbox 控制器**：用于输入控制命令的主要设备
3. **地面站**：主要负责构建通信上下位机通信，通过电力载波（直白讲就是让高压电同时供电并提供信号，减少信息号衰减），让电脑接入ROV局域网
4. **ROV 本体**：下面对“超越”架构进行简单介绍：
   1.路由器（建立 ROV 内部局域网，与地面站进行数据交换）2. 网络摄像头（通过 RTSP协议推送视频）3.控制核心板（包括推力芯片和信号处理芯片）4.电调（接收核心板的
   PWM / CAN 控制信号）

### 软件架构

控制系统采用模块化设计，主要包含以下模块：

1. **主控制器（MainController）**：
    - 协调各个模块的工作
    - 管理主循环和程序生命周期

2. **配置管理器（ConfigManager）**：
    - 加载和管理配置文件
    - 提供统一的配置访问接口
    - 处理电机曲线参数

3. **硬件控制器（HardwareController）**：
    - 与 ROV 硬件通信
    - 发送控制命令
    - 接收传感器数据

4. **控制器监视器（ControllerMonitor）**：
    - 跟踪控制器状态
    - 管理传感器数据

5. **网络工作线程（NetworkWorker）**：
    - 处理网络通信
    - 确保命令和数据的可靠传输

6. **手柄控制器（JoystickController）**：
    - 处理手柄输入
    - 实现各种控制模式
    - 转换用户输入为电机命令

7. **UI 控制器（UIController）**：
    - 管理用户界面
    - 显示视频流和状态信息
    - 处理键盘输入

8. **视频处理线程（VideoThread）**：
    - 接收和处理视频流
    - 校正图像畸变
    - 提供帧捕获功能

9. **深度温度线程（DepthTemperatureThread）**：
    - 记录深度和温度数据
    - 保存数据到文件

### 通信流程

1. **上位机 → ROV**：
    - 通过 UDP 协议发送 JSON 格式的控制命令
    - 命令包含电机推力、舵机位置等信息

2. **ROV → 上位机**：
    - 通过 UDP 协议发送 JSON 格式的传感器数据
    - 数据包含深度、温度等信息
    - 通过 RTSP 协议发送视频流

## 安装与设置

### 系统要求

- **操作系统**：Windows 10/11、Linux 或 macOS
- **Python 版本**：Python 3.8+
- **外部依赖**：FFmpeg（用于视频流处理；Windows 发行版已内置，源码运行需自行安装并加入 PATH）
- **硬件要求**：Xbox 控制器（推荐使用 Xbox One 或 Xbox Series 控制器）

### 安装步骤

1. **克隆或下载项目**：
   ```
   git clone git@github.com:exp-049/upper_controller-wuurc.git
   cd upper_controller-wuurc
   ```

2. **安装 FFmpeg**：
    - **Windows**：
        1. 从 [FFmpeg 官网](https://ffmpeg.org/download.html) 下载 Windows 版本
        2. 解压到任意目录（如 `C:\ffmpeg`）
        3. 将 FFmpeg 的 bin 目录（如 `C:\ffmpeg\bin`）添加到系统环境变量 PATH 中
        4. 重启命令提示符或 PowerShell 以使更改生效
        5. 验证安装：`ffmpeg -version`

    - **Linux (Ubuntu/Debian)**：
      ```
      sudo apt update
      sudo apt install ffmpeg
      ffmpeg -version
      ```

    - **macOS**：
      ```
      brew install ffmpeg
      ffmpeg -version
      ```

3. **安装 Python 依赖**：
   ```
   pip install -r requirements.txt
   ```

4. **连接 Xbox 控制器**：
    - 通过 USB 或蓝牙将 Xbox 控制器连接到计算机
    - 确保控制器被系统识别

5. **配置网络连接**：
    - 确保上位机和 ROV 在同一网络中
    - 记录 ROV 的 IP 地址，并在配置文件中更新

### 启动系统

1. **启动方式**：
    - **Windows**：双击 `scripts/start.bat`
    - **命令行**：`python main.py`
    - **可执行文件**：如果已打包，双击 `ROV_Controller.exe`

2. **使用自定义配置**：
    - 修改 `modules/config_manager.py` 中的默认配置路径
    - 或在命令行中指定：`python main.py --config config/your_custom_config.ini`

## 配置选项

系统使用 INI 格式的配置文件和 JSON 格式的电机曲线参数文件。以下是主要配置选项的说明：

### config/config_beyond.ini

配置文件分为多个部分：

1. **[camera]** - 摄像头设置
    - `host` - 摄像头 IP 地址
    - `username` - 摄像头登录用户名
    - `password` - 摄像头登录密码
    - `width` - 视频宽度
    - `height` - 视频高度
    - `buffer` - 缓冲区大小

2. **[serial]** - 网络设置
    - `host` - ROV 的 IP 地址
    - `remote_port` - ROV 的端口
    - `local_port` - 上位机的端口

3. **[servo]** - 舵机设置
    - `close` - 爪子闭合位置
    - `open` - 爪子完全打开位置
    - `mid1`, `mid2`, `mid3` - 中间位置
    - 各按键映射

4. **[x]**, **[y]**, **[z]**, **[yaw]** - 运动控制设置
    - `max` - 最大推力值
    - `axis` - 对应的摇杆轴
    - `deadzone` - 摇杆死区

5. **[speed_mode]**, **[lock_mode]**, **[loop_mode]** - 模式设置
    - `button` - 触发按钮
    - `trig` - 触发方式
    - `rate0`, `rate1`, `rate2` - 速度系数

6. **[joystick]** - 手柄设置
    - `buttons` - 按钮数量
    - `axes` - 轴数量
    - `tick` - 主循环频率

7. **[interface]** - 界面设置
    - `width`, `height` - 窗口尺寸
    - `font` - 字体
    - `font_size` - 字体大小

8. **[keyboard_bindings]** - 键盘绑定
    - 各功能对应的键位

### config/curve.json

电机曲线参数文件，包含：

- 每个电机（m0-m5）的参数
- 控制曲线的关键点参数，用于将摇杆输入转换为电机推力

### 自定义配置

如需创建自定义配置：

1. 复制 `config/config_beyond.ini` 到新文件（如 `config/config_custom.ini`）
2. 根据需要修改设置
3. 在启动时指定新的配置文件

## 使用说明

### 手柄控制

- **左摇杆**：
    - 上下：Y 轴移动
    - 左右：X 轴移动
    - 按下：切换舵机锁定状态

- **右摇杆**：
    - 上下：Z 轴移动
    - 左右：Yaw 旋转

- **A 键**：速度模式切换（在三种速度模式之间循环）
- **B 键**：切换抓取模式
- **Y 键**：爪子切换至转换张角
- **X 键**：爪子切换至特定张角
- **左肩键**：爪子切换至最大张角
- **右肩键**：爪子闭合

- **左线性扳机**：
    1. 给予所有运动速度一个随着扳机扣下 1~0.25 变化的附加系数
    2. 扣下过 20%，自动进入轻柔模式状态，松开退回原状态

- **右线性扳机**：
    1. 在未锁定模式下扳机线性处理
    2. 在锁定模式下按到最低，切换至释放模式，释放舵机可对爪子进行从当前状态到最大闭合状态的线性控制

- **Xbox 键**：按下时阻塞进程，缓解延迟问题
- **左侧按钮(6)**：启动/停止深度温度记录

### 键盘控制

- **T 键**：切换屏幕方向（横屏/竖屏）
- **F 键**：切换全屏模式
- **D 键**：启动 Xbox 调试器，用于查看键位映射
- **S 键**：切换有/无畸变显示
- **P 键**：捕获当前视频帧
- **Q 键**：退出程序

### 界面说明

界面主要显示以下信息：

1. **视频流**：显示 ROV 摄像头捕获的实时画面
2. **控制状态**：显示当前的控制模式和参数
3. **深度温度**：显示当前的深度和水温
4. **电机状态**：显示各电机的推力值
5. **系统状态**：显示系统运行状态和警告信息

## 设计原理

### 为什么采用模块化设计？

模块化设计是软件工程中的最佳实践，它带来以下好处：

1. **提高可维护性**：每个模块负责特定功能，便于定位和修复问题
2. **提高可扩展性**：可以轻松添加新功能或修改现有功能
3. **提高代码复用性**：模块可以在不同项目中重用
4. **提高团队协作效率**：不同开发者可以同时处理不同模块

### 为什么使用多线程？

系统使用多线程处理以下任务：

1. **视频处理**：视频解码和处理是计算密集型任务，放在单独线程中可以避免阻塞主线程
2. **网络通信**：网络操作可能有延迟，使用单独线程可以避免影响用户界面响应
3. **深度温度记录**：数据记录需要定期执行，使用单独线程可以确保准确的时间间隔

这种设计确保了系统的响应性和稳定性，即使在高负载情况下也能保持流畅的用户体验。

### 为什么使用 FFmpeg？

FFmpeg 是一个强大的多媒体处理工具，用于视频流处理的原因包括：

1. **高效解码**：FFmpeg 提供高效的视频解码能力，减少 CPU 负载
2. **广泛兼容性**：支持多种视频格式和协议，包括 RTSP
3. **低延迟**：能够以低延迟方式处理视频流，这对实时控制至关重要

### 电机曲线设计原理

电机曲线是将摇杆输入（-1.0 到 1.0 的值）转换为电机推力值的映射函数。这种映射不是线性的，而是经过精心设计的曲线，目的是：

1. **提供精细控制**：在低速区域提供更精细的控制
2. **确保平滑过渡**：避免突然的速度变化
3. **适应不同任务**：不同的电机可能需要不同的控制曲线

曲线参数存储在 `curve.json` 文件中，可以根据需要进行调整。

## 工作流程

### 系统启动流程

1. **初始化配置**：
    - 加载配置文件
    - 初始化电机参数

2. **初始化硬件连接**：
    - 设置网络套接字
    - 连接到 ROV

3. **初始化线程**：
    - 启动视频处理线程
    - 启动网络工作线程

4. **初始化用户界面**：
    - 设置显示窗口
    - 加载字体和图像

5. **进入主循环**

### 主循环流程

1. **处理事件**：
    - 获取最新视频帧
    - 处理键盘和窗口事件

2. **更新手柄状态**：
    - 读取手柄输入
    - 处理按钮和摇杆状态

3. **处理控制逻辑**：
    - 根据当前模式处理输入
    - 计算电机推力值

4. **发送控制命令**：
    - 将命令发送到 ROV

5. **接收传感器数据**：
    - 接收深度、温度等数据

6. **更新显示**：
    - 显示视频帧
    - 显示控制状态和传感器数据

7. **控制循环频率**：
    - 根据配置的 tick 值控制循环频率

### 数据流向

1. **用户输入 → 控制命令**：
    - 手柄输入由 JoystickController 处理
    - 转换为电机推力值和舵机位置

2. **控制命令 → ROV**：
    - 由 HardwareController 发送到 ROV
    - 使用 UDP 协议，JSON 格式

3. **ROV → 传感器数据**：
    - ROV 发送深度、温度等数据
    - 由 NetworkWorker 接收并处理

4. **ROV → 视频流**：
    - 通过 RTSP 协议发送
    - 由 VideoThread 接收并处理

5. **数据 → 用户界面**：
    - 由 UIController 显示在界面上

## 故障排除

### 常见问题及解决方法

1. **黑屏问题**：
    - **症状**：启动后只显示黑屏，没有视频画面
    - **原因**：软件正在尝试接收视频流，但连接未建立
    - **解决方法**：
        - 检查网络连接
        - 确认摄像头 IP 地址和凭据正确
        - 检查 ROV 和路由器是否正常工作
        - 等待连接建立（可能需要几秒钟）

2. **控制无响应**：
    - **症状**：手柄输入没有反应，ROV 不移动
    - **原因**：可能是 ROV 内部初始化延迟或网络问题
    - **解决方法**：
        - 检查网络连接
        - 确认 ROV 已正确启动
        - 检查配置文件中的 IP 地址和端口
        - 耐心等待；必要时重启软件

3. **延迟问题**：
    - **症状**：控制有明显延迟，视频卡顿
    - **原因**：启动时视频处理线程负载高或网络拥塞
    - **解决方法**：
        - 按下 Xbox 键暂时阻塞进程
        - 检查网络质量
        - 降低视频分辨率（在配置文件中）

4. **全屏失焦**：
    - **问题**：全屏模式下失去焦点会切换屏幕
    - **解决方法**：比赛中避免切换窗口

5. **FFmpeg 错误**：
    - **症状**：启动时出现 FFmpeg 相关错误
    - **原因**：FFmpeg 未正确安装或未添加到 PATH
    - **解决方法**：
        - 重新安装 FFmpeg
        - 确保 FFmpeg 的 bin 目录已添加到系统 PATH
        - 重启计算机后再试

6. **SDL3 库加载失败**：
    - **症状**：启动时出现 SDL3 相关错误
    - **原因**：Pygame 2.5.0+ 使用 SDL3，可能在打包后无法正确加载
    - **解决方法**：
        - 使用最新版本的打包脚本
        - 或手动降级 Pygame：`pip install pygame==2.4.0 --force-reinstall`

### 调试工具

系统提供了多种调试工具，帮助你诊断和解决问题：

1. **Xbox 调试器**：
    - 按下 D 键启动
    - 显示所有控制器输入的实时值
    - 帮助检查控制器是否正常工作

2. **控制器可视化工具**：
    - 位于 `tools/controller_visualizer.py`
    - 提供控制器状态的图形化显示

3. **推力曲线调试器**：
    - 位于 `tools/thrust_curve_debugger.py`
    - 可视化电机曲线，帮助调整参数

4. **控制器映射编辑器**：
    - 位于 `tools/controller_mapping_editor.py`
    - 允许自定义控制器按键映射

## 进阶开发

### 扩展系统功能

如果你想扩展系统功能，以下是一些建议：

1. **添加新模块**：
    - 在 `modules` 目录下创建新的 Python 文件
    - 在 `main.py` 中导入并使用新模块

2. **修改现有模块**：
    - 了解模块的职责和接口
    - 保持接口兼容性，避免破坏现有功能

3. **添加新配置选项**：
    - 在配置文件中添加新的部分或选项
    - 在 `config_manager.py` 中添加相应的访问方法

4. **改进用户界面**：
    - 修改 `ui_controller.py` 中的显示逻辑
    - 添加新的信息显示或控制元素

### 自定义电机曲线

电机曲线对 ROV 的控制精度和响应性有重要影响。如需自定义：

1. 使用 `tools/thrust_curve_debugger.py` 工具可视化当前曲线
2. 修改 `curve.json` 文件中的参数
3. 测试新曲线的效果，根据需要进行调整

### 打包为可执行文件

可以将程序打包为可执行文件，方便分发和使用：

1. **打包方法**：
    - 双击 `build_exe.bat` 启动打包过程
    - 或运行命令：`python build_exe.py`

2. **打包结果**：
    - 打包完成后，可执行文件位于 `dist/ROV_Controller` 目录中
    - 使用了目录模式而非单文件模式，大幅减小了文件大小
    - 运行时请执行目录中的 `ROV_Controller.exe` 文件

---

希望这份指南能够帮助你快速上手 ROV 控制系统。如果你有任何问题或建议，请随时联系我们。祝你在水下探索中取得成功！

*张殷瑞 & 人机交互世水版本*

*最后更新：2025-08-04*
