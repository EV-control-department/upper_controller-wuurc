# 控制器工具文档

## 概述

ROV控制系统提供了两个专用工具，用于可视化控制器输入和配置控制器映射：

1. **控制器可视化工具**：提供图形化界面，实时显示控制器按钮和轴的状态，帮助用户识别按钮和轴的编号。
2. **控制器映射编辑器**：允许用户查看和修改控制器按钮和轴的映射配置。

这些工具旨在简化控制器配置过程，使用户能够轻松地识别控制器输入并根据需要调整映射。

## 控制器可视化工具

### 功能

- 图形化显示控制器按钮和轴的状态
- 实时反馈按钮按下和轴移动
- 清晰显示按钮和轴的编号
- 显示当前配置中的控制器映射

### 启动方式

有三种方式启动控制器可视化工具：

1. 在主应用程序中按下 `V` 键（可在配置文件中自定义）
2. 运行 `tools/start_controller_visualizer.bat` 批处理文件
3. 直接运行 `python tools/controller_visualizer.py`

### 使用说明

1. 启动工具后，界面分为左右两部分：
    - 左侧显示控制器按钮、轴和帽子开关的可视化表示
    - 右侧显示当前配置中的控制器映射信息

2. 操作控制器时，可以观察到：
    - 按下按钮时，对应的按钮图形会变红
    - 移动摇杆时，对应的轴指示器会移动
    - 使用帽子开关时，对应的指示点会移动

3. 通过观察可视化界面，可以确定：
    - 每个物理按钮对应的按钮编号
    - 每个摇杆轴对应的轴编号
    - 帽子开关的方向值

## 控制器映射编辑器

### 功能

- 查看和修改控制器轴映射（X、Y、Z、偏航）
- 查看和修改按钮映射（舵机控制、模式切换等）
- 实时测试映射更改
- 保存配置到文件

### 启动方式

有三种方式启动控制器映射编辑器：

1. 在主应用程序中按下 `M` 键（可在配置文件中自定义）
2. 运行 `tools/start_controller_mapping_editor.bat` 批处理文件
3. 直接运行 `python tools/controller_mapping_editor.py`

### 使用说明

1. 启动编辑器后，选择要编辑的配置文件（默认加载 `config` 目录中的配置文件）

2. 轴映射选项卡：
    - 可以修改每个控制轴（X、Y、Z、偏航）的映射
    - 对于每个轴，可以设置：
        - 轴编号：控制器上对应的轴编号
        - 死区值：忽略小输入的阈值（0.0-1.0）
        - 最大值：轴输入映射的最大输出值
    - 修改后点击"应用更改"按钮应用到当前会话

3. 按钮映射选项卡：
    - 可以修改舵机控制按钮和模式切换按钮的映射
    - 对于每个功能，可以设置对应的按钮编号
    - 修改后点击"应用更改"按钮应用到当前会话

4. 保存配置：
    - 点击顶部的"保存配置"按钮将更改永久保存到配置文件
    - 保存后需要重启主应用程序才能生效

## 键盘快捷键

在主应用程序中，可以使用以下键盘快捷键访问控制器工具：

| 功能         | 默认快捷键 | 配置项                       |
|------------|-------|---------------------------|
| 打开Xbox调试器  | D     | xbox_debugger_key         |
| 打开控制器可视化工具 | V     | controller_visualizer_key |
| 打开控制器映射编辑器 | M     | controller_mapping_key    |

这些快捷键可以在配置文件的 `[keyboard_bindings]` 部分自定义。

## 配置文件结构

控制器映射配置存储在配置文件（如 `config_beyond.ini`）中的以下部分：

### 轴映射

```ini
[x]
max = 3000
axis = 0
deadzone = 0.05

[y]
max = 5000
axis = 1
deadzone = 0.05

[z]
max = 6000
axis = 3
deadzone = 0.05

[yaw]
max = -600
axis = 2
deadzone = 0.05
```

### 按钮映射

```ini
[servo]
close_button = 5
close_trig = down
open_button = 4
open_trig = down
mid1_button = 2
mid1_trig = down
mid2_button = 3
mid2_trig = down

[speed_mode]
button = 0
trig = down

[lock_mode]
button = 1
trig = down

[loop_mode]
button = 2
trig = down
```

### 键盘绑定

```ini
[keyboard_bindings]
xbox_debugger_key = d
controller_visualizer_key = v
controller_mapping_key = m
```

## 注意事项

- 修改控制器映射后，需要重启主应用程序才能生效
- 使用控制器可视化工具确定正确的按钮和轴编号，然后使用控制器映射编辑器进行配置
- 建议在修改配置前备份原始配置文件
- 如果控制器未连接，工具会显示"未检测到控制器"的提示