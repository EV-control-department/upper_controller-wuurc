# 双曲线视图修复说明

## 修复的问题

在推力曲线调试器的双曲线视图功能中，我们修复了以下问题：

1. **双曲线视图初始化问题**：启用双曲线视图后，两条曲线不会立即显示，需要选择比较电机后才会显示
2. **拖拽时视图切换问题**：在双曲线视图中拖拽点时，视图会突然变成单曲线视图
3. **参数更新问题**：拖拽比较曲线的点时，对应电机的参数没有正确更新

## 技术原因分析

1. **视图切换问题**：
    - 在 `_update_ui_for_motor` 方法中直接调用了 `plot_curve` 而不是 `_update_curve_only`
    - `plot_curve` 方法会重置 `is_dual_view` 状态为 `False`，导致双曲线视图丢失
    - 拖拽点时会触发 `on_plot_drag_finished`，进而调用 `_update_ui_for_motor`

2. **参数更新问题**：
    - 拖拽比较曲线点时，`DraggablePointPlot` 类会更新内部的 `comparison_params`
    - 但这些更新没有同步回 `MainWindow` 类的 `motor_data`
    - 导致比较电机的参数更改在拖拽后丢失

## 修复方案

1. **修复视图切换问题**：
    - 修改 `_update_ui_for_motor` 方法，使用 `_update_curve_only` 代替 `plot_curve`
    - `_update_curve_only` 会根据 `dual_view_active` 状态决定是显示单曲线还是双曲线

2. **修复参数更新问题**：
    - 修改 `on_plot_drag_finished` 方法，在双曲线视图模式下：
    - 检查 `plot_canvas` 是否有 `comparison_params` 属性
    - 如果有，将其同步回 `motor_data[comparison_motor]`

## 验证测试

我们创建了一个测试脚本 `test_dual_view_fixes.py` 来验证修复效果：

1. **测试双曲线视图初始化**：
    - 切换到双曲线视图
    - 验证 `plot_canvas.is_dual_view` 是否为 `True`

2. **测试拖拽主曲线点**：
    - 模拟拖拽主曲线的点
    - 验证拖拽后 `is_dual_view` 是否仍为 `True`

3. **测试拖拽比较曲线点**：
    - 模拟拖拽比较曲线的点
    - 验证比较电机参数是否正确更新
    - 验证拖拽后 `is_dual_view` 是否仍为 `True`

## 如何运行测试

使用提供的批处理文件运行测试：

```
tools\run_dual_view_test.bat
```

测试将自动执行并显示结果。如果所有测试都通过，将显示：

```
测试完成! 所有修复已验证:
1. 双曲线视图正确初始化 ✓
2. 拖拽主曲线点时保持双曲线视图 ✓
3. 拖拽比较曲线点时参数正确更新 ✓
```

## 总结

这些修复确保了双曲线视图功能的正常工作，使用户可以：

1. 启用双曲线视图后立即看到两条曲线
2. 在拖拽任何曲线上的点时保持双曲线视图状态
3. 拖拽比较曲线上的点时正确更新比较电机的参数

这些改进大大提高了双曲线编辑功能的可用性和稳定性。